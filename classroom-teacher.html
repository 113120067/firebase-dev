<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ•™å¸«æ§åˆ¶å° - Classroom MVP</title>
  <link rel="stylesheet" href="/public/css/classroom.css">
</head>
<body>
  <div class="wide-container">
    <h1>ğŸ“š æ•™å¸«æ§åˆ¶å°</h1>
    
    <!-- èª²å ‚è³‡è¨Š -->
    <div class="card">
      <h2 id="classroomName">è¼‰å…¥ä¸­...</h2>
      <p><strong>èª²å ‚ä»£ç¢¼ï¼š</strong><span id="classroomCode" style="font-size: 1.5rem; color: #1a73e8; font-weight: bold;">----</span></p>
      <p><strong>å–®å­—æ•¸é‡ï¼š</strong><span id="wordCount">0</span> å€‹</p>
    </div>

    <!-- çµ±è¨ˆè³‡è¨Š -->
    <div class="stats-grid">
      <div class="stat-card">
        <span class="stat-value" id="avgTime">0 åˆ†</span>
        <span class="stat-label">å¹³å‡å­¸ç¿’æ™‚é–“</span>
      </div>
      <div class="stat-card">
        <span class="stat-value" id="maxTime">0 åˆ†</span>
        <span class="stat-label">æœ€é«˜å­¸ç¿’æ™‚é–“</span>
      </div>
      <div class="stat-card">
        <span class="stat-value" id="activeStudents">0</span>
        <span class="stat-label">æ´»èºå­¸ç”Ÿæ•¸</span>
      </div>
    </div>

    <!-- å³æ™‚æ’è¡Œæ¦œ -->
    <div class="card">
      <h2>ğŸ† å³æ™‚æ’è¡Œæ¦œ</h2>
      <div id="leaderboardContainer">
        <p class="text-center" style="color: #5f6368;">å°šç„¡å­¸ç”ŸåŠ å…¥èª²å ‚</p>
      </div>
    </div>
  </div>

  <script type="module">
    import { initialize, onAuthStateChanged } from '/firebase-config.js';
    import { getClassroom, onClassroomStudentsChanged } from '/firebase-classroom.js';
    import { showLoading, hideLoading, showError, formatTime, getUrlParam } from '/public/js/classroom-utils.js';

    let currentUser = null;
    let classroomId = null;
    let unsubscribeStudents = null;

    // åˆå§‹åŒ–
    async function init() {
      try {
        await initialize();
        
        onAuthStateChanged(async user => {
          if (user) {
            currentUser = user;
            await loadClassroom();
          } else {
            alert('è«‹å…ˆç™»å…¥');
            window.location.href = '/login.html';
          }
        });
      } catch (error) {
        console.error('Initialization error:', error);
        showError('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼š' + error.message);
      }
    }

    // è¼‰å…¥èª²å ‚è³‡æ–™
    async function loadClassroom() {
      classroomId = getUrlParam('id');
      
      if (!classroomId) {
        showError('ç¼ºå°‘èª²å ‚ ID');
        return;
      }

      try {
        showLoading();
        
        const classroom = await getClassroom(classroomId);
        
        if (!classroom) {
          hideLoading();
          showError('æ‰¾ä¸åˆ°æ­¤èª²å ‚');
          return;
        }

        // æª¢æŸ¥æ˜¯å¦ç‚ºèª²å ‚æ•™å¸«
        if (classroom.teacherId !== currentUser.uid) {
          hideLoading();
          alert('æ‚¨ä¸æ˜¯æ­¤èª²å ‚çš„æ•™å¸«');
          window.location.href = '/index.html';
          return;
        }

        // é¡¯ç¤ºèª²å ‚è³‡è¨Š
        document.getElementById('classroomName').textContent = classroom.name;
        document.getElementById('classroomCode').textContent = classroom.code;
        document.getElementById('wordCount').textContent = classroom.wordCount;

        hideLoading();

        // ç›£è½å­¸ç”Ÿè®ŠåŒ–
        setupStudentsListener();

      } catch (error) {
        hideLoading();
        console.error('Error loading classroom:', error);
        showError('è¼‰å…¥èª²å ‚è³‡æ–™å¤±æ•—ï¼š' + error.message);
      }
    }

    // è¨­ç½®å­¸ç”Ÿå³æ™‚ç›£è½
    function setupStudentsListener() {
      if (unsubscribeStudents) {
        unsubscribeStudents();
      }

      onClassroomStudentsChanged(classroomId, (students) => {
        updateLeaderboard(students);
        updateStats(students);
      });
    }

    // æ›´æ–°æ’è¡Œæ¦œ
    function updateLeaderboard(students) {
      const container = document.getElementById('leaderboardContainer');
      
      if (students.length === 0) {
        container.innerHTML = '<p class="text-center" style="color: #5f6368;">å°šç„¡å­¸ç”ŸåŠ å…¥èª²å ‚</p>';
        return;
      }

      // æŒ‰ç…§ totalTime æ’åºï¼ˆå·²ç”± query æ’åºï¼‰
      const leaderboardHTML = students.map((student, index) => {
        const rank = index + 1;
        const rankClass = `leaderboard-item rank-${rank}`;
        const medal = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : '';
        
        return `
          <div class="${rank <= 3 ? rankClass : 'leaderboard-item'}" onclick="viewStudentDetail('${student.id}')">
            <span class="rank">${rank}.</span>
            <span class="student-name">${student.studentName}</span>
            <span class="student-time">${formatTime(student.totalTime)}</span>
            ${medal ? `<span class="medal">${medal}</span>` : ''}
          </div>
        `;
      }).join('');

      container.innerHTML = leaderboardHTML;
    }

    // æ›´æ–°çµ±è¨ˆè³‡è¨Š
    function updateStats(students) {
      if (students.length === 0) {
        document.getElementById('avgTime').textContent = '0 åˆ†';
        document.getElementById('maxTime').textContent = '0 åˆ†';
        document.getElementById('activeStudents').textContent = '0';
        return;
      }

      // è¨ˆç®—å¹³å‡å­¸ç¿’æ™‚é–“
      const totalTime = students.reduce((sum, s) => sum + s.totalTime, 0);
      const avgTime = Math.floor(totalTime / students.length);
      document.getElementById('avgTime').textContent = Math.floor(avgTime / 60) + ' åˆ†';

      // æœ€é«˜å­¸ç¿’æ™‚é–“
      const maxTime = Math.max(...students.map(s => s.totalTime));
      document.getElementById('maxTime').textContent = Math.floor(maxTime / 60) + ' åˆ†';

      // æ´»èºå­¸ç”Ÿæ•¸ï¼ˆç¸½å­¸ç¿’æ™‚é–“ > 0ï¼‰
      const activeCount = students.filter(s => s.totalTime > 0).length;
      document.getElementById('activeStudents').textContent = activeCount;
    }

    // æŸ¥çœ‹å­¸ç”Ÿè©³æƒ…
    window.viewStudentDetail = function(studentId) {
      window.location.href = `/student-detail.html?studentId=${studentId}`;
    };

    // åˆå§‹åŒ–
    init();
  </script>
</body>
</html>
