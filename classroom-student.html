<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­¸ç¿’ä¸­ - Classroom MVP</title>
  <link rel="stylesheet" href="/public/css/classroom.css">
</head>
<body>
  <div class="container">
    <!-- èª²å ‚è³‡è¨Š -->
    <div class="card text-center">
      <h1>ğŸ“š <span id="classroomName">è¼‰å…¥ä¸­...</span></h1>
      <p style="font-size: 1.2rem;">Hi, <span id="studentName">è¼‰å…¥ä¸­...</span>ï¼</p>
    </div>

    <!-- å­¸ç¿’è¨ˆæ™‚å™¨ -->
    <div class="card learning-panel">
      <h2>â±ï¸ æˆ‘çš„å­¸ç¿’æ™‚é–“</h2>
      <div class="timer-display" id="timerDisplay">0 åˆ† 0 ç§’</div>
      <div class="control-buttons">
        <button id="startBtn" class="btn btn-success">é–‹å§‹å­¸ç¿’</button>
        <button id="endBtn" class="btn btn-danger" style="display: none;">çµæŸå­¸ç¿’</button>
      </div>
    </div>

    <!-- å–®å­—ç·´ç¿’å€ -->
    <div id="practiceSection" class="hidden">
      <div class="card">
        <h2>ğŸ“ å–®å­—ç·´ç¿’</h2>
        <div class="word-card">
          <div class="word-display" id="currentWord">---</div>
          <div class="word-actions">
            <button id="knowBtn" class="btn btn-success" style="font-size: 1.2rem; padding: 15px 30px;">âœ“ çŸ¥é“</button>
            <button id="dontKnowBtn" class="btn btn-danger" style="font-size: 1.2rem; padding: 15px 30px;">âœ— ä¸çŸ¥é“</button>
          </div>
          <div class="progress-display">
            é€²åº¦ï¼š<span id="currentIndex">0</span> / <span id="totalWords">0</span>
          </div>
        </div>
      </div>
    </div>

    <!-- æˆ‘çš„æ’å -->
    <div class="card">
      <h2>ğŸ… æˆ‘çš„æ’å</h2>
      <p class="text-center" style="font-size: 1.3rem;">
        ç¬¬ <span id="myRank" style="color: #1a73e8; font-weight: bold;">-</span> å / å…± <span id="totalStudents">0</span> äºº
      </p>
      <p class="text-center" style="color: #5f6368;">
        ç¸½å­¸ç¿’æ™‚é–“ï¼š<span id="myTotalTime">0 åˆ† 0 ç§’</span>
      </p>
    </div>

    <!-- æ’è¡Œæ¦œ Top 5 -->
    <div class="card">
      <h2>ğŸ† æ’è¡Œæ¦œ Top 5</h2>
      <div id="leaderboardTop5">
        <p class="text-center" style="color: #5f6368;">è¼‰å…¥ä¸­...</p>
      </div>
    </div>
  </div>

  <script type="module">
    import { initialize } from '/firebase-config.js';
    import { 
      getClassroom, 
      getStudentDetail,
      startLearningSession,
      endLearningSession,
      recordPractice,
      getLeaderboard
    } from '/firebase-classroom.js';
    import { 
      showLoading, 
      hideLoading, 
      showError, 
      showSuccess,
      formatTime,
      getUrlParam,
      shuffleArray
    } from '/public/js/classroom-utils.js';

    let studentId = null;
    let classroomId = null;
    let classroom = null;
    let student = null;
    let sessionId = null;
    let isLearning = false;
    let startTime = null;
    let timerInterval = null;
    let currentWordIndex = 0;
    let words = [];
    let practiceCount = 0;
    let correctCount = 0;

    // åˆå§‹åŒ–
    async function init() {
      try {
        await initialize();
        
        studentId = getUrlParam('studentId');
        classroomId = getUrlParam('classroomId');

        if (!studentId || !classroomId) {
          showError('ç¼ºå°‘å¿…è¦åƒæ•¸');
          return;
        }

        await loadData();
      } catch (error) {
        console.error('Initialization error:', error);
        showError('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼š' + error.message);
      }
    }

    // è¼‰å…¥è³‡æ–™
    async function loadData() {
      try {
        showLoading();

        // è¼‰å…¥èª²å ‚è³‡æ–™
        classroom = await getClassroom(classroomId);
        if (!classroom) {
          hideLoading();
          showError('æ‰¾ä¸åˆ°èª²å ‚');
          return;
        }

        // è¼‰å…¥å­¸ç”Ÿè³‡æ–™
        student = await getStudentDetail(studentId);
        if (!student) {
          hideLoading();
          showError('æ‰¾ä¸åˆ°å­¸ç”Ÿè³‡æ–™');
          return;
        }

        // é¡¯ç¤ºè³‡è¨Š
        document.getElementById('classroomName').textContent = classroom.name;
        document.getElementById('studentName').textContent = student.studentName;
        document.getElementById('myTotalTime').textContent = formatTime(student.totalTime);

        // è¼‰å…¥æ’è¡Œæ¦œ
        await updateLeaderboard();

        hideLoading();
      } catch (error) {
        hideLoading();
        console.error('Error loading data:', error);
        showError('è¼‰å…¥è³‡æ–™å¤±æ•—ï¼š' + error.message);
      }
    }

    // æ›´æ–°æ’è¡Œæ¦œ
    async function updateLeaderboard() {
      try {
        const leaderboard = await getLeaderboard(classroomId);
        
        // æ‰¾å‡ºè‡ªå·±çš„æ’å
        const myRank = leaderboard.findIndex(s => s.id === studentId) + 1;
        document.getElementById('myRank').textContent = myRank > 0 ? myRank : '-';
        document.getElementById('totalStudents').textContent = leaderboard.length;

        // é¡¯ç¤º Top 5
        const top5 = leaderboard.slice(0, 5);
        const top5HTML = top5.map((s, index) => {
          const rank = index + 1;
          const isMe = s.id === studentId;
          const medal = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : '';
          
          return `
            <div class="${rank <= 3 ? 'leaderboard-item rank-' + rank : 'leaderboard-item'}">
              <span class="rank">${rank}.</span>
              <span class="student-name">${s.studentName}${isMe ? ' (æˆ‘)' : ''}</span>
              <span class="student-time">${formatTime(s.totalTime)}</span>
              ${medal ? `<span class="medal">${medal}</span>` : ''}
            </div>
          `;
        }).join('');

        document.getElementById('leaderboardTop5').innerHTML = top5HTML;

      } catch (error) {
        console.error('Error updating leaderboard:', error);
      }
    }

    // é–‹å§‹å­¸ç¿’
    async function startLearning() {
      try {
        showLoading();

        // å»ºç«‹å­¸ç¿’éšæ®µ
        sessionId = await startLearningSession(studentId, classroomId);
        
        isLearning = true;
        startTime = Date.now();
        
        // æ‰“äº‚å–®å­—é †åº
        words = shuffleArray(classroom.words);
        currentWordIndex = 0;
        practiceCount = 0;
        correctCount = 0;

        // é–‹å§‹è¨ˆæ™‚
        startTimer();

        // é¡¯ç¤ºç·´ç¿’å€
        document.getElementById('practiceSection').classList.remove('hidden');
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('endBtn').style.display = 'inline-block';

        // é¡¯ç¤ºç¬¬ä¸€å€‹å–®å­—
        showNextWord();

        hideLoading();
        showSuccess('é–‹å§‹å­¸ç¿’ï¼');

      } catch (error) {
        hideLoading();
        console.error('Error starting learning:', error);
        showError('é–‹å§‹å­¸ç¿’å¤±æ•—ï¼š' + error.message);
      }
    }

    // çµæŸå­¸ç¿’
    async function finishLearning() {
      if (!isLearning) return;

      try {
        showLoading();

        // åœæ­¢è¨ˆæ™‚
        stopTimer();

        const duration = Math.floor((Date.now() - startTime) / 1000);

        // å„²å­˜å­¸ç¿’è¨˜éŒ„
        await endLearningSession(sessionId, {
          duration,
          practiceCount,
          correctCount
        });

        isLearning = false;
        sessionId = null;

        // éš±è—ç·´ç¿’å€
        document.getElementById('practiceSection').classList.add('hidden');
        document.getElementById('startBtn').style.display = 'inline-block';
        document.getElementById('endBtn').style.display = 'none';

        // é‡æ–°è¼‰å…¥è³‡æ–™
        await loadData();

        hideLoading();
        showSuccess('å­¸ç¿’è¨˜éŒ„å·²å„²å­˜ï¼');

      } catch (error) {
        hideLoading();
        console.error('Error ending learning:', error);
        showError('çµæŸå­¸ç¿’å¤±æ•—ï¼š' + error.message);
      }
    }

    // è¨ˆæ™‚å™¨
    function startTimer() {
      timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById('timerDisplay').textContent = formatTime(elapsed);
      }, 1000);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    // é¡¯ç¤ºä¸‹ä¸€å€‹å–®å­—
    function showNextWord() {
      if (currentWordIndex >= words.length) {
        // å·²ç·´ç¿’å®Œæ‰€æœ‰å–®å­—
        alert('å·²ç·´ç¿’å®Œæ‰€æœ‰å–®å­—ï¼');
        currentWordIndex = 0; // é‡æ–°é–‹å§‹
      }

      const word = words[currentWordIndex];
      document.getElementById('currentWord').textContent = word;
      document.getElementById('currentIndex').textContent = currentWordIndex + 1;
      document.getElementById('totalWords').textContent = words.length;
    }

    // è™•ç†ã€ŒçŸ¥é“ã€æŒ‰éˆ•
    async function handleKnow() {
      if (!isLearning) return;

      const word = words[currentWordIndex];
      practiceCount++;
      correctCount++;

      try {
        await recordPractice(studentId, word, true);
        currentWordIndex++;
        showNextWord();
      } catch (error) {
        console.error('Error recording practice:', error);
        showError('è¨˜éŒ„ç·´ç¿’å¤±æ•—');
      }
    }

    // è™•ç†ã€Œä¸çŸ¥é“ã€æŒ‰éˆ•
    async function handleDontKnow() {
      if (!isLearning) return;

      const word = words[currentWordIndex];
      practiceCount++;

      try {
        await recordPractice(studentId, word, false);
        currentWordIndex++;
        showNextWord();
      } catch (error) {
        console.error('Error recording practice:', error);
        showError('è¨˜éŒ„ç·´ç¿’å¤±æ•—');
      }
    }

    // äº‹ä»¶ç›£è½
    document.getElementById('startBtn').addEventListener('click', startLearning);
    document.getElementById('endBtn').addEventListener('click', finishLearning);
    document.getElementById('knowBtn').addEventListener('click', handleKnow);
    document.getElementById('dontKnowBtn').addEventListener('click', handleDontKnow);

    // åˆå§‹åŒ–
    init();
  </script>
</body>
</html>
