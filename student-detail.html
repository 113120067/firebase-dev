<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­¸ç”Ÿè©³æƒ… - Classroom MVP</title>
  <link rel="stylesheet" href="/public/css/classroom.css">
</head>
<body>
  <div class="container">
    <h1>å­¸ç”Ÿè©³æƒ…</h1>
    
    <!-- å­¸ç”ŸåŸºæœ¬è³‡è¨Š -->
    <div class="card">
      <h2 id="studentName">è¼‰å…¥ä¸­...</h2>
      <p><strong>åŠ å…¥æ™‚é–“ï¼š</strong><span id="joinedAt">-</span></p>
      <p><strong>ç¸½å­¸ç¿’æ™‚é–“ï¼š</strong><span id="totalTime">0 åˆ† 0 ç§’</span></p>
      <p><strong>å­¸ç¿’æ¬¡æ•¸ï¼š</strong><span id="totalSessions">0</span> æ¬¡</p>
      <p><strong>æœ€å¾Œæ´»èºï¼š</strong><span id="lastActive">-</span></p>
    </div>

    <!-- å–®å­—æ­£ç¢ºç‡çµ±è¨ˆ -->
    <div class="card">
      <h2>ğŸ“Š å–®å­—æ­£ç¢ºç‡</h2>
      <table class="word-stats-table" id="wordStatsTable">
        <thead>
          <tr>
            <th>å–®å­—</th>
            <th>æ­£ç¢º</th>
            <th>éŒ¯èª¤</th>
            <th>æ­£ç¢ºç‡</th>
          </tr>
        </thead>
        <tbody id="wordStatsBody">
          <tr>
            <td colspan="4" class="text-center" style="color: #5f6368;">è¼‰å…¥ä¸­...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- å­¸ç¿’è¨˜éŒ„ -->
    <div class="card">
      <h2>ğŸ“ å­¸ç¿’è¨˜éŒ„</h2>
      <table class="sessions-table" id="sessionsTable">
        <thead>
          <tr>
            <th>æ—¥æœŸæ™‚é–“</th>
            <th>æ™‚é•·</th>
            <th>ç·´ç¿’æ¬¡æ•¸</th>
            <th>æ­£ç¢ºç‡</th>
          </tr>
        </thead>
        <tbody id="sessionsBody">
          <tr>
            <td colspan="4" class="text-center" style="color: #5f6368;">è¼‰å…¥ä¸­...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="mt-20">
      <button onclick="history.back()" class="btn btn-secondary">è¿”å›</button>
    </div>
  </div>

  <script type="module">
    import { initialize, onAuthStateChanged } from '/firebase-config.js';
    import { getStudentDetail } from '/firebase-classroom.js';
    import { 
      showLoading, 
      hideLoading, 
      showError, 
      formatTime,
      formatDateTime,
      formatAccuracy,
      getAccuracyClass,
      calculateAccuracy,
      getUrlParam 
    } from '/public/js/classroom-utils.js';

    let currentUser = null;
    let studentId = null;

    // åˆå§‹åŒ–
    async function init() {
      try {
        await initialize();
        
        onAuthStateChanged(async user => {
          if (user) {
            currentUser = user;
            await loadStudentDetail();
          } else {
            alert('è«‹å…ˆç™»å…¥');
            window.location.href = '/login.html';
          }
        });
      } catch (error) {
        console.error('Initialization error:', error);
        showError('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼š' + error.message);
      }
    }

    // è¼‰å…¥å­¸ç”Ÿè©³æƒ…
    async function loadStudentDetail() {
      studentId = getUrlParam('studentId');
      
      if (!studentId) {
        showError('ç¼ºå°‘å­¸ç”Ÿ ID');
        return;
      }

      try {
        showLoading();
        
        const studentDetail = await getStudentDetail(studentId);
        
        if (!studentDetail) {
          hideLoading();
          showError('æ‰¾ä¸åˆ°æ­¤å­¸ç”Ÿ');
          return;
        }

        // é¡¯ç¤ºåŸºæœ¬è³‡è¨Š
        document.getElementById('studentName').textContent = studentDetail.studentName;
        document.getElementById('joinedAt').textContent = formatDateTime(studentDetail.joinedAt);
        document.getElementById('totalTime').textContent = formatTime(studentDetail.totalTime);
        document.getElementById('totalSessions').textContent = studentDetail.totalSessions || 0;
        document.getElementById('lastActive').textContent = formatDateTime(studentDetail.lastActive);

        // é¡¯ç¤ºå–®å­—çµ±è¨ˆ
        displayWordStats(studentDetail.wordStats, studentDetail.words);

        // é¡¯ç¤ºå­¸ç¿’è¨˜éŒ„
        displaySessions(studentDetail.sessions);

        hideLoading();

      } catch (error) {
        hideLoading();
        console.error('Error loading student detail:', error);
        showError('è¼‰å…¥å­¸ç”Ÿè³‡æ–™å¤±æ•—ï¼š' + error.message);
      }
    }

    // é¡¯ç¤ºå–®å­—çµ±è¨ˆ
    function displayWordStats(wordStats, words) {
      const tbody = document.getElementById('wordStatsBody');
      
      if (!wordStats || Object.keys(wordStats).length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center" style="color: #5f6368;">å°šç„¡ç·´ç¿’è¨˜éŒ„</td></tr>';
        return;
      }

      const rows = Object.entries(wordStats).map(([word, stats]) => {
        const correct = stats.correct || 0;
        const wrong = stats.wrong || 0;
        const total = correct + wrong;
        const accuracy = calculateAccuracy(correct, total);
        const accuracyClass = getAccuracyClass(accuracy);

        return `
          <tr>
            <td>${word}</td>
            <td>${correct}</td>
            <td>${wrong}</td>
            <td class="${accuracyClass}">${formatAccuracy(accuracy)}</td>
          </tr>
        `;
      }).join('');

      tbody.innerHTML = rows;
    }

    // é¡¯ç¤ºå­¸ç¿’è¨˜éŒ„
    function displaySessions(sessions) {
      const tbody = document.getElementById('sessionsBody');
      
      if (!sessions || sessions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center" style="color: #5f6368;">å°šç„¡å­¸ç¿’è¨˜éŒ„</td></tr>';
        return;
      }

      const rows = sessions.map(session => {
        const accuracy = session.accuracy || 0;
        const accuracyClass = getAccuracyClass(accuracy);

        return `
          <tr>
            <td>${formatDateTime(session.startTime)}</td>
            <td>${formatTime(session.duration)}</td>
            <td>${session.practiceCount || 0}</td>
            <td class="${accuracyClass}">${formatAccuracy(accuracy)}</td>
          </tr>
        `;
      }).join('');

      tbody.innerHTML = rows;
    }

    // åˆå§‹åŒ–
    init();
  </script>
</body>
</html>
